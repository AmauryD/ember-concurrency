<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ember-concurrency</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
<meta name="dummy/config/environment" content="%7B%22modulePrefix%22%3A%22dummy%22%2C%22environment%22%3A%22production%22%2C%22rootURL%22%3A%22%2F%22%2C%22locationType%22%3A%22auto%22%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%2C%22_APPLICATION_TEMPLATE_WRAPPER%22%3Afalse%2C%22_DEFAULT_ASYNC_OBSERVERS%22%3Atrue%2C%22_JQUERY_INTEGRATION%22%3Atrue%2C%22_TEMPLATE_ONLY_GLIMMER_COMPONENTS%22%3Atrue%7D%2C%22APP%22%3A%7B%22name%22%3A%22ember-concurrency%22%2C%22version%22%3A%222.0.0%2B5be155e1%22%7D%2C%22fastboot%22%3A%7B%22hostWhitelist%22%3A%5B%7B%7D%2C%22ember-concurrency.com%22%5D%7D%2C%22exportApplicationGlobal%22%3Afalse%7D" />
<!-- EMBER_CLI_FASTBOOT_TITLE -->

    <link integrity="" rel="stylesheet" href="/assets/vendor-e754b247f0b14ad5fde0f302404dd7cb.css">
    <link integrity="" rel="stylesheet" href="/assets/dummy-7531a7ac8fca261643d73af00e241483.css">
    <link href='//fonts.googleapis.com/css?family=Raleway:400,300,600' rel='stylesheet' type='text/css'>

    
  </head>
  <body>
    <script type="x/boundary" id="fastboot-body-start"></script><div class="container navbar">
  <div class="row">
    <div class="ten columns">
      <h3 style="float:left;">
        ember-concurrency

        <span style="font-size: 0.5em;">
          (v 2.0.0)
        </span>
      </h3>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="/api">API</a>
      </div>
    </div>
    <div class="one columns">
      <div class="nav-bar-link-outer">
        <a href="https://github.com/machty/ember-concurrency" target="_blank" rel="noopener noreferrer">GitHub</a>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="docs row">
    <div class="three columns">
      <div class="side-menu">
            <div class="toc-entry">
                <a href="/docs/introduction" id="ember243" class="ember-view">Home</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/installation" id="ember244" class="ember-view">Installation</a>
            </div>


<!---->            <div class="toc-section-title">
              Introduction
            </div>
            <div class="toc-entry">
                <a href="/docs/tutorial" id="ember245" class="ember-view">Writing Code Without Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/tutorial/discussion" id="ember246" class="ember-view">Post-Mortem</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/tutorial/refactor" id="ember247" class="active ember-view">Refactoring With Tasks</a>
            </div>


<!---->            <div class="toc-section-title">
              Reference
            </div>
            <div class="toc-entry">
                <a href="/docs/task-function-syntax" id="ember248" class="ember-view">Task Function Syntax</a>
            </div>


                <div class="toc-entry toc-subentry">
                  <a href="/docs/task-decorators" id="ember249" class="ember-view">Decorators</a>
                </div>
                <div class="toc-entry toc-subentry">
                  <a href="/docs/typescript" id="ember250" class="ember-view">TypeScript</a>
                </div>
            <div class="toc-entry">
                <a href="/docs/task-concurrency" id="ember251" class="ember-view">Managing Task Concurrency</a>
            </div>


                <div class="toc-entry toc-subentry">
                  <a href="/docs/task-concurrency-advanced" id="ember252" class="ember-view">Advanced</a>
                </div>
            <div class="toc-entry">
                <a href="/docs/cancelation" id="ember253" class="ember-view">Cancelation</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/error-vs-cancelation" id="ember254" class="ember-view">Handling Errors</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/child-tasks" id="ember255" class="ember-view">Child Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/task-groups" id="ember256" class="ember-view">Task Groups</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/derived-state" id="ember257" class="ember-view">Derived State</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/encapsulated-task" id="ember258" class="ember-view">Encapsulated Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/events" id="ember259" class="ember-view">Awaiting Events / Conditions</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/task-lifecycle-events" id="ember260" class="ember-view">Lifecycle Events</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/testing-debugging" id="ember261" class="ember-view">Testing &amp; Debugging</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/faq" id="ember262" class="ember-view">FAQ &amp; Fact Sheet</a>
            </div>


<!---->            <div class="toc-section-title">
              Examples
            </div>
            <div class="toc-entry">
                <a href="/docs/examples/loading-ui" id="ember263" class="ember-view">Loading UI</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/examples/autocomplete" id="ember264" class="ember-view">Type-Ahead Search</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/examples/increment-buttons" id="ember265" class="ember-view">Accelerating Increment Buttons</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/examples/ajax-throttling" id="ember266" class="ember-view">AJAX Throttling</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/examples/route-tasks" id="ember267" class="ember-view">Route Tasks</a>
            </div>


<!---->            <div class="toc-entry">
                <a href="/docs/examples/joining-tasks" id="ember268" class="ember-view">Awaiting Multiple Child Tasks</a>
            </div>


<!---->      </div>
    </div>
    <div class="nine columns">
      <div class="row">
    <p class="u-pull-left">
      Previous: <a href="/docs/tutorial/discussion" id="ember269" class="ember-view">Post-Mortem</a>
    </p>

    <p class="u-pull-right">
      Next: <a href="/docs/task-function-syntax" id="ember270" class="ember-view">Task Function Syntax</a>
    </p>
</div>

      <a title="Edit on Github" href="https://github.com/machty/ember-concurrency/edit/master/tests/dummy/app/docs/tutorial/refactor/template.hbs" id="ember271" class="github-edit ember-view"><i class="icon-pencil"></i>
</a>

      <h3>Refactoring With Tasks</h3>

<p>
  Now we're going to build the same functionality using
  ember-concurrency tasks, starting with the same bare minimum
  implementation as before, and making incremental improvements.
</p>

<p>
  For reference, here is the bare minimum implementation that we
  started with before (which only uses core Ember APIs):
</p>

<div id="ember272" class="ember-view"><div class="code-template-toggle">
  <div class="code-template-toggle-section hidden">
    <pre id="ember273" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
  </div>
  <div class="code-template-toggle-section ">
    <pre id="ember274" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial0 extends TutorialComponent {
  result = null;

  @action
  async findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    let coords = await geolocation.getCoords()
    let result = await store.getNearbyStores(coords);

    this.set('result', result);
  }
}
</pre>
  </div>
  <span role="button" class="button code-template-toggle-button">
    Toggle JS / Template
  </span>
</div>
</div>
<div id="ember275" class="ember-view"><div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<h4>Version 1: Bare Minimum Implementation (with Tasks)</h4>

<p>
  Now let's build the same thing with ember-concurrency tasks:
</p>

<div id="ember276" class="ember-view"><div class="code-template-toggle">
  <div class="code-template-toggle-section hidden">
    <pre id="ember277" class="htmlbars ember-view">&lt;button {{on "click" (perform this.findStores)}} type="button"&gt; {{! ++ }}
  Find Nearby Stores
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
  </div>
  <div class="code-template-toggle-section ">
    <pre id="ember278" class="javascript ember-view">import { task } from 'ember-concurrency';

export default class Tutorial6 extends TutorialComponent {
  result = null;

  @task *findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }
}
</pre>
  </div>
  <span role="button" class="button code-template-toggle-button">
    Toggle JS / Template
  </span>
</div>
</div>
<div id="ember279" class="ember-view"><div class="tutorial-example">

  <button type="button"> 
    Find Nearby Stores
  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
  Let's take a moment to point out everything that has changed:
</p>

<p>
  First, instead of using a <code>findStores</code> <em>action</em>,
  we define a <code>findStores</code> <em>task</em>.
</p>

<p>
  Second, in the template, instead of using <code>onclick={{action 'findStores'}}</code>,
  we use <code>onclick={{perform findStores}}</code>.
</p>

<p>
  Lastly, instead of using an <code>async</code> function with <code>await</code>
  calls, we use the
  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*">Generator Function Syntax</a>
  and the <code>yield</code> keyword.
</p>

<p>
  <a href="/docs/task-function-syntax" id="ember280" class="ember-view">We'll get into much greater detail</a>
  about how this syntax is used, but for now, the most important thing to understand
  is that when you <code>yield</code> a promise or async function, the task will
  pause until that promise or async function fulfills,
  and then continue executing with the resolved value of that promise or async function.

  Semantically, it is roughly the same as using <code>await</code>, but using
  generator functions allows controlling the execution in a way that using
  native, browser-managed <code>async/await</code> does not.
</p>

<p>Let's press onward with the refactor:</p>

<h5>Version 2: Add a Loading Spinner (with Tasks)</h5>

<p>
  Rather than defining a separate boolean flag and manually tracking
  the state of the task, we can use the <code>isRunning</code> property
  exposed by the task to drive our loading spinner, which means we only
  need to make a change to the template code; the JavaScript can stay the same:
</p>

<div id="ember281" class="ember-view"><div class="code-template-toggle">
  <div class="code-template-toggle-section ">
    <pre id="ember282" class="htmlbars ember-view">&lt;button {{on "click" (perform this.findStores)}} type="button"&gt;
  Find Nearby Stores
  {{#if this.findStores.isRunning}}
    {{! ++ }}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
  </div>
  <div class="code-template-toggle-section hidden">
    <pre id="ember283" class="javascript ember-view">import { task } from 'ember-concurrency';

export default class Tutorial7 extends TutorialComponent {
  result = null;

  @task *findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }
}
</pre>
  </div>
  <span role="button" class="button code-template-toggle-button">
    Toggle JS / Template
  </span>
</div>
</div>
<div id="ember284" class="ember-view"><div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<h4>Version 3: Preventing Concurrency (with Tasks)</h4>

<p>
  So far so good, but we still haven't addressed the issue that clicking
  the button multiple times causes weird behavior due to multiple
  fetch operations running at the same time.
</p>

<p>
  Rather than putting an <code>if</code> guard at the start of the task,
  the ember-concurrency way to prevent concurrency is to apply a
  <a href="/docs/task-concurrency" id="ember285" class="ember-view">Task Modifier</a> to the task.
  The one we want to use is the <code>drop</code> modifier, which prevents
  concurrency by "dropping" any attempt to perform the task while it is
  already running.
</p>

<div id="ember286" class="ember-view"><div class="code-template-toggle">
  <div class="code-template-toggle-section hidden">
    <pre id="ember287" class="htmlbars ember-view">&lt;button {{on "click" (perform this.findStores)}} type="button"&gt;
  Find Nearby Stores
  {{#if this.findStores.isRunning}}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
  </div>
  <div class="code-template-toggle-section ">
    <pre id="ember288" class="javascript ember-view">import { task } from 'ember-concurrency';

export default class Tutorial8 extends TutorialComponent {
  result = null;

  @task({ drop: true }) // ++
  *findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }
}
</pre>
  </div>
  <span role="button" class="button code-template-toggle-button">
    Toggle JS / Template
  </span>
</div>
</div>
<div id="ember289" class="ember-view"><div class="tutorial-example">

  <button type="button">
    Find Nearby Stores
<!---->  </button>

<!---->
  <span class="tutorial-example-label">Example</span>
</div>
</div>

<p>
  Now when you button mash "Find Nearby Stores", you no longer get the weird
  behavior due to concurrent fetches.
</p>

<h4>Version 4: Handling "set on destroyed object" errors (with Tasks)</h4>

<p>
  What about those pesky <code>"set on destroyed object"</code> errors?
</p>

<p>
  Good news! Our code is already safe because ember-concurrency automatically
  cancels tasks when their host object (e.g. a Component) is destroyed.
  In our example, if the <code>findStores</code> task is paused
  at the unresolved <code>getNearbyStores</code> <code>await</code> call right
  when the user navigates away, the component will be destroyed and the
  <code>findStores</code> task will stop right where it is and will never hit
  the line of code with the <code>this.set()</code>, thus avoiding the
  <code>"set on destroyed object"</code> error.
</p>

<p>
  The ability to cancel a task in mid-execution is one of ember-concurrency's
  most powerful features, and it is the generator function syntax that
  makes cancelation possible.
</p>

<h4>Version 5: Handle Promise Rejection/Async Exceptions (with Tasks)</h4>

<p>
  Will a promise rejection/async exception put our task into an unrecoverable state?
</p>

<p>
  It turns out that, again, we don't need to change any code; if either
  <code>getCoords</code> or <code>getNearbyStores</code> throw an exception,
  the <code>findStores</code> task would stop execution where the error occurred, bubble
  the exception to the console (so that error reporters can catch it), but from there on
  the task can be immediately performed / retried again. So, we don't need to change any code.
</p>

<h3>Final Diff</h3>

<p>
  JavaScript:
</p>

<div id="ember290" class="ember-view"><div class="code-template-toggle">
  <div class="code-template-toggle-section hidden">
    <pre id="ember291" class="javascript ember-view">import { action } from '@ember/object';

export default class Tutorial5 extends TutorialComponent {
  result = null;
  isFindingStores = false;

  @action
  async findStores() {
    if (this.isFindingStores) { return; }

    let geolocation = this.geolocation;
    let store = this.store;

    this.set('isFindingStores', true);

    try {
      let coords = await geolocation.getCoords()
      let result = await store.getNearbyStores(coords);

      if (this.isDestroyed) { return; }

      this.set('result', result);
    } finally {
      if (!this.isDestroyed) {
        this.set('isFindingStores', false);
      }
    }
  }
}
</pre>
  </div>
  <div class="code-template-toggle-section ">
    <pre id="ember292" class="javascript ember-view">import { task } from 'ember-concurrency';

export default class Tutorial9 extends TutorialComponent {
  result = null;

  @task({ drop: true })
  *findStores() {
    let geolocation = this.geolocation;
    let store = this.store;

    let coords = yield geolocation.getCoords();
    let result = yield store.getNearbyStores(coords);
    this.set('result', result);
  }
}
</pre>
  </div>
  <span role="button" class="button code-template-toggle-button">
    diff
  </span>
</div>
</div>

<p>
  <br>
  Template:
</p>

<div id="ember293" class="ember-view"><div class="code-template-toggle">
  <div class="code-template-toggle-section hidden">
    <pre id="ember294" class="htmlbars ember-view">&lt;button {{on "click" this.findStores}} type="button"&gt;
  Find Nearby Stores
  {{#if this.isFindingStores}}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
  </div>
  <div class="code-template-toggle-section ">
    <pre id="ember295" class="htmlbars ember-view">&lt;button {{on "click" (perform this.findStores)}} type="button"&gt;
  Find Nearby Stores
  {{#if this.findStores.isRunning}}
    &lt;LoadingSpinner /&gt;
  {{/if}}
&lt;/button&gt;

{{#if this.result}}
  {{#each this.result.stores as |s|}}
    &lt;li&gt;
      &lt;strong&gt;{{s.name}}&lt;/strong&gt;:
      {{s.distance}} miles away
    &lt;/li&gt;
  {{/each}}
{{/if}}
</pre>
  </div>
  <span role="button" class="button code-template-toggle-button">
    diff
  </span>
</div>
</div>

<br>
<h3>Conclusion</h3>

<p>
  This was a very successful refactor. We were able to remove a lot
  of ugly boilerplate and defensive programming code, and what we're left
  with is very clean, concise, safe, and stress-free code.
</p>


      <br> <br> <br> <br>

      <div class="row">
    <p class="u-pull-left">
      Previous: <a href="/docs/tutorial/discussion" id="ember296" class="ember-view">Post-Mortem</a>
    </p>

    <p class="u-pull-right">
      Next: <a href="/docs/task-function-syntax" id="ember297" class="ember-view">Task Function Syntax</a>
    </p>
</div>

    </div>
  </div>
</div>


<div id="ember298" class="ember-notify-cn ember-notify-default ember-view"><!----></div>
<script type="x/boundary" id="fastboot-body-end"></script>

    <script src="/assets/vendor-837a9bb2198479b906aec0f3105565d4.js"></script>
    <script src="/assets/dummy-2547396e77499aeaa84c1cfdba0cfd87.js"></script>

    
  </body>
</html>
